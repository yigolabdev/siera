rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // 헬퍼 함수
    // ========================================
    
    // 사용자 인증 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 승인된 회원 확인
    function isApproved() {
      return isAuthenticated() && 
             request.auth.token.isApproved == true;
    }
    
    // 관리자 권한 확인
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.role == 'chairman' || 
              request.auth.token.role == 'vice_chairman' ||
              request.auth.token.role == 'secretary');
    }
    
    // 본인 데이터 확인
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // 회원 (members) 컬렉션
    // ========================================
    match /members/{memberId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성: 회원가입 시 자신의 문서만 (isApproved는 false로 시작)
      allow create: if isAuthenticated() && 
                      request.auth.uid == memberId &&
                      request.resource.data.isApproved == false;
      
      // 수정: 본인 또는 관리자
      allow update: if isOwner(memberId) || isAdmin();
      
      // 삭제: 관리자만
      allow delete: if isAdmin();
    }
    
    // ========================================
    // 산행 (events) 컬렉션
    // ========================================
    match /events/{eventId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성, 수정, 삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // 참석자 (participants) 컬렉션
    // ========================================
    match /participants/{participantId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성: 본인의 참석 신청만 (회원 본인)
      allow create: if isAuthenticated() && 
                      isApproved() &&
                      request.auth.uid == request.resource.data.memberId;
      
      // 수정: 본인 또는 관리자 (상태 변경 등)
      allow update: if isOwner(resource.data.memberId) || isAdmin();
      
      // 삭제: 본인 또는 관리자
      allow delete: if isOwner(resource.data.memberId) || isAdmin();
    }
    
    // ========================================
    // 조 편성 (teams) 컬렉션
    // ========================================
    match /teams/{teamId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성, 수정, 삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // 공지사항 (notices) 컬렉션
    // ========================================
    match /notices/{noticeId} {
      // 읽기: 모든 인증된 사용자 (공지사항은 공개)
      allow read: if isAuthenticated();
      
      // 생성, 수정, 삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // 게시판 (posts) 컬렉션
    // ========================================
    match /posts/{postId} {
      // 읽기: 모든 인증된 사용자
      allow read: if isAuthenticated();
      
      // 생성: 인증된 사용자 (본인 정보로)
      allow create: if isAuthenticated() && 
                      request.auth.uid == request.resource.data.authorId;
      
      // 수정: 본인 또는 관리자
      allow update: if isOwner(resource.data.authorId) || isAdmin();
      
      // 삭제: 본인 또는 관리자
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // ========================================
    // 댓글 (comments) 컬렉션
    // ========================================
    match /comments/{commentId} {
      // 읽기: 모든 인증된 사용자
      allow read: if isAuthenticated();
      
      // 생성: 인증된 사용자 (본인 정보로)
      allow create: if isAuthenticated() && 
                      request.auth.uid == request.resource.data.authorId;
      
      // 수정: 본인 또는 관리자
      allow update: if isOwner(resource.data.authorId) || isAdmin();
      
      // 삭제: 본인 또는 관리자
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // ========================================
    // 사연 (poems) 컬렉션
    // ========================================
    match /poems/{poemId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성: 승인된 회원 (본인 정보로)
      allow create: if isAuthenticated() && 
                      isApproved() &&
                      request.auth.uid == request.resource.data.authorId;
      
      // 수정: 본인 또는 관리자
      allow update: if isOwner(resource.data.authorId) || isAdmin();
      
      // 삭제: 본인 또는 관리자
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // ========================================
    // 갤러리 (gallery) 컬렉션
    // ========================================
    match /gallery/{imageId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성: 승인된 회원
      allow create: if isAuthenticated() && 
                      isApproved() &&
                      request.auth.uid == request.resource.data.uploadedBy;
      
      // 수정, 삭제: 업로더 본인 또는 관리자
      allow update, delete: if isOwner(resource.data.uploadedBy) || isAdmin();
    }
    
    // ========================================
    // 운영진 (executives) 컬렉션
    // ========================================
    match /executives/{executiveId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성, 수정, 삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // 회칙 (rules) 컬렉션
    // ========================================
    match /rules/{ruleId} {
      // 읽기: 인증되고 승인된 회원만
      allow read: if isAuthenticated() && isApproved();
      
      // 생성, 수정, 삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // 대기 회원 (pendingUsers) 컬렉션
    // ========================================
    match /pendingUsers/{userId} {
      // 읽기, 수정, 삭제: 관리자만
      allow read, update, delete: if isAdmin();
      
      // 생성: 회원가입 시 자동 생성
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // 기본 거부
    // ========================================
    // 위에 명시되지 않은 모든 컬렉션은 접근 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
