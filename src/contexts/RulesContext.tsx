import { createContext, useContext, useState, ReactNode, useMemo, useCallback, useEffect } from 'react';
import { getDocuments, setDocument, updateDocument } from '../lib/firebase/firestore';
import { logError, ErrorLevel, ErrorCategory } from '../utils/errorHandler';
import { RulesData, RulesAmendment } from '../types';
import { waitForFirebase } from '../lib/firebase/config';
import { useAuth } from './AuthContextEnhanced';

interface RulesContextType {
  rulesData: RulesData;
  isLoading: boolean;
  error: string | null;
  updateRules: (content: string, version: string, effectiveDate: string) => Promise<void>;
  addAmendment: (amendment: RulesAmendment) => Promise<void>;
  refreshRules: () => Promise<void>;
}

const RulesContext = createContext<RulesContextType | undefined>(undefined);

// ì´ˆê¸° íšŒì¹™ ë‚´ìš© (ì™„ì „íŒ) - Firebaseì— ì—†ì„ ë•Œ ì‚¬ìš©
const initialRulesContent = `# ì œ 1ì¥. ì´ì¹™

## ì œ 1ì¡° (ëª…ì¹­)
ë³¸íšŒëŠ” 'ì‹œì• ë¼'ë¼ ì¹­í•˜ë©°, í•œë¬¸ëª…ì€ 'è©©æ„›ç¾…,' ì˜ë¬¸ëª…ì€ 'Sierra'ë¡œ í•œë‹¤.

## ì œ 2ì¡° (ëª©ì )
ë³¸íšŒëŠ” ëŒ€í•œë¯¼êµ­ì˜ ì‚°ì—…ê³„, í•™ê³„/ì—°êµ¬ê¸°ê´€, ë° ì •ë¶€/ê³µê³µê¸°ê´€ ë¦¬ë”ë“¤ì˜ ë“±ì‚°ë™í˜¸íšŒë¡œì„œ íšŒì›ë“¤ì´ ì‚°í–‰ì„ í†µí•˜ì—¬ ì‹¬ì‹ ì„ ë‹¨ë ¨í•˜ê³  íšŒì› ìƒí˜¸ê°„ ì¹œëª©ê³¼ í˜‘ë ¥ì„ ë„ëª¨í•¨ì„ ê·¸ ëª©ì ìœ¼ë¡œ í•œë‹¤.

## ì œ 3ì¡° (ì‚¬ì—…)
ë³¸íšŒëŠ” ê·¸ ëª©ì ì„ ë‹¬ì„±í•˜ê¸° ìœ„í•˜ì—¬ ë‹¤ìŒì˜ ì‚¬ì—…ì„ ì¶”ì§„í•œë‹¤.

1. ì •ê¸°ì‚°í–‰ì„ ë§¤ì›” 1íšŒ ë‹¹ì¼ ì‚°í–‰ìœ¼ë¡œ ì‹¤ì‹œí•˜ë˜, ì´ ì¤‘ 1íšŒëŠ” 1ë°•2ì¼ ì¼ì •ìœ¼ë¡œ ì‹¤ì‹œí•œë‹¤.
2. í•´ì™¸ì‚°í–‰ì„ ì—° 1íšŒ ì‹¤ì‹œí•  ìˆ˜ ìˆë‹¤.
3. ë³¸íšŒì˜ ëª©ì ì— ë¶€í•©í•˜ëŠ” ë¬¸í™”í–‰ì‚¬, ì¹œëª©í–‰ì‚¬, ë˜ëŠ” ì‚¬íšŒê³µí—Œí™œë™ì„ ì‹¤ì‹œí•  ìˆ˜ ìˆë‹¤.
4. ì œ3ì¡° 1í•­ ë‚´ì§€ 3í•­ì˜ ì‚¬ì—…ì€ íšŒì¹™ì´ ì •í•˜ëŠ” ì ˆì°¨ì— ë”°ë¼ ê¸°íšÂ·ì‹œí–‰í•˜ë©°, ê·¸ ê²°ê³¼ë¥¼ íšŒì›ì—ê²Œ ë³´ê³ í•œë‹¤.

---

# ì œ 2ì¥. íšŒì›

## ì œ 4ì¡° (ìê²© ë° ì…íšŒì ˆì°¨)
1. ë³¸íšŒì˜ íšŒì›ì€ ë³¸íšŒì˜ ëª©ì ì— ê³µê°í•˜ê³  ì´ë¥¼ ì‹¤í–‰í•˜ë©°, ë³¸íšŒê°€ ì •í•˜ëŠ” ë°”ì— ë”°ë¥¸ ì—°íšŒë¹„ë¥¼ ë‚©ë¶€í•œ ìë¡œ í•œë‹¤.
2. íšŒì›ì˜ ìê²©ì€ ë§¤í•´ 1ì›” 1ì¼ ì œ 4ì¡° 1í•­ì— ì •í•œ ê¸°ì¤€ì„ ì ìš©í•˜ì—¬ ê°±ì‹ ëœë‹¤.
3. ì…íšŒë¥¼ í¬ë§í•˜ëŠ” ìëŠ” ë³¸íšŒì˜ ì •ê¸°ì‚°í–‰ì— 1íšŒ ì´ìƒ ì°¸ì—¬í•œ í›„, ìš´ì˜ìœ„ì›íšŒì˜ ì‹¬ì˜ë¥¼ ê±°ì³ ê·¸ ì…íšŒì—¬ë¶€ê°€ ê²°ì •ëœë‹¤. ì‹ ì…íšŒì›ì˜ ì—°ë ¹ì€ ì…íšŒì¼ ê¸°ì¤€ ë§Œ 25ì„¸ ì´ìƒ, ë§Œ 65ì„¸ ì´í•˜ë¡œ í•œì •í•œë‹¤. ë³¸íšŒì˜ í™œë™ì„ 1ì›” ì •ê¸°ì‚°í–‰ ì´í›„ ì‹œì‘í•œ ì‹ ì…íšŒì›ì€ ì…íšŒì‹œê¸°ì— ë”°ë¼ ì›”í•  ê³„ì‚°ëœ ì—°íšŒë¹„ë¥¼ ë‚©ë¶€í•œë‹¤.

## ì œ 5ì¡° (ê¶Œë¦¬)
1. ë³¸íšŒê°€ ì£¼ìµœí•˜ëŠ” ì‚°í–‰ ë° ì—¬íƒ€ í–‰ì‚¬ì— ì°¸ì—¬í•  ê¶Œë¦¬
2. ë³¸íšŒì˜ ìš´ì˜ì— ì°¸ì—¬í•  ê¶Œë¦¬ ë° ë°œì–¸ê¶Œ
3. ë³¸íšŒì˜ ìš´ì˜ ë‚´ìš©ì— ëŒ€í•œ ì•Œ ê¶Œë¦¬
4. ë³¸íšŒì˜ ëª©ì ì— ë¶€í•©ëœ ê¸°íƒ€ í˜œíƒì„ ë°›ì„ ê¶Œë¦¬

## ì œ 6ì¡° (ì˜ë¬´)
1. ë³¸íšŒì˜ íšŒì¹™ ë° ëŒ€ì˜ì›íšŒì˜ì™€ ìš´ì˜ìœ„ì›íšŒì˜ ì œ ì˜ê²°ì‚¬í•­ì„ ì¤€ìˆ˜í•˜ì—¬ì•¼ í•œë‹¤.
2. ë³¸íšŒê°€ ì£¼ìµœí•˜ëŠ” ì‚¬ì—…ì— ëŠ¥ë™ì ìœ¼ë¡œ ì°¸ì—¬í•˜ì—¬ì•¼ í•œë‹¤.
3. ì†Œì •ì˜ íšŒë¹„ë¥¼ ë‚©ë¶€í•˜ì—¬ì•¼ í•œë‹¤.

## ì œ 7ì¡° (ì§•ê³„ ë° ì œëª…)
ë³¸íšŒì˜ íšŒì› ì¤‘ ì œ 2ì¡°ì— ëª…ì‹œëœ ë³¸íšŒì˜ ëª©ì ì„ ìœ„ë°°í•˜ê±°ë‚˜ ì œ 4ì¡°ì˜ ìê²© ìš”ê±´ ë˜ëŠ” ì œ 6ì¡°ì˜ ì˜ë¬´ë¥¼ ì´í–‰í•˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ì˜ì›íšŒì˜ì˜ ê²°ì˜ì— ì˜í•´ ì§•ê³„ ë˜ëŠ” ì œëª…í•  ìˆ˜ ìˆë‹¤.

---

# ì œ 3ì¥. ìš´ì˜ì¡°ì§ êµ¬ì„±

## ì œ 8ì¡° (ì„ì›)
1. íšŒì¥ì€ ë³¸íšŒë¥¼ ëŒ€í‘œí•˜ë©°, íšŒë¬´ë¥¼ ì´ê´„í•˜ê³ , ìš´ì˜ìœ„ì›íšŒì™€ ëŒ€ì˜ì›íšŒì˜ì˜ ì˜ì¥ì´ ëœë‹¤.
2. ìš´ì˜ê°ì‚¬ëŠ” ì—…ë¬´ì§‘í–‰ ì „ë°˜ê³¼ íšŒì›ì˜ ì˜ë¬´ì´í–‰ ì—¬ë¶€ë¥¼ ê°ì‚¬í•˜ë©°, ì¬ë¬´ê°ì‚¬ëŠ” íšŒê³„ ì •ë³´ë¥¼ í‰ê°€í•˜ê³  ê°ì‚¬í•œë‹¤.
3. ìš´ì˜ìœ„ì›ì¥ì€ íšŒì¥ì„ ë³´ì¢Œí•˜ë©°, íšŒì¥ ë¶€ì¬ ì‹œ ê·¸ ì§ë¬´ë¥¼ ëŒ€í–‰í•œë‹¤. ë³¸íšŒì˜ ìš´ì˜ ì „ë°˜ì— ê´€í•œ ì‹¤ë¬´ë¥¼ ì´ê´„í•œë‹¤.
4. ë“±ì‚°ëŒ€ì¥ì€ ë“±ì‚° ì „ë¬¸ê°€ë¡œì„œ ì‚°í–‰ì§€ ë° ì‚°í–‰ì½”ìŠ¤ë¥¼ ì„ ì •í•˜ê³ , ìœ„í—˜ì„ ì˜ˆì¸¡í•˜ê³  ëŒ€ë¹„í•˜ë©°, ì‚°í–‰ ì¤‘ íšŒì›ë“¤ì„ í†µì†”í•˜ê³  ì•ˆì „ì„ ì±…ì„ì§€ëŠ” ì—­í• ì„ í•œë‹¤. ë“±ì‚°ëŒ€ì¥ì€ ìš´ì˜ìœ„ì›íšŒì— ì‚°í–‰ ê³„íšì•ˆ ë° ì¤€ë¹„ìƒí™©ì„ ì‚¬ì „ì— ê³µìœ í•˜ê³  ì—…ë¬´ì§‘í–‰ì— ì ê·¹ í˜‘ì¡°í•œë‹¤.
5. ì¬ë¬´ìœ„ì›ì€ ë³¸íšŒì˜ ì¬ë¬´ì—…ë¬´ë¥¼ ì´ê´„í•˜ê³  íšŒì¹™ì´ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ íšŒê³„ë³´ê³ ë¥¼ í•œë‹¤.
6. ê¸°íƒ€ ìš´ì˜ìœ„ì›(5ì¸ ë‚´ì™¸)ì€ íšŒì¥ê³¼ ìš´ì˜ìœ„ì›ì¥ì„ ë„ì™€ ì‚¬ì—…ê¸°íšê³¼ ì—…ë¬´ì§‘í–‰ì— ì ê·¹ ì°¸ì—¬í•œë‹¤.

## ì œ 9ì¡° (ìš´ì˜ìœ„ì›íšŒ)
1. ìš´ì˜ìœ„ì›íšŒëŠ” ë³¸íšŒì˜ ìš´ì˜ ì£¼ì²´ë¡œì„œ ì£¼ìš” ì‚¬ì—…, íšŒì›ê´€ë¦¬, ë° ì˜ˆì‚°ì§‘í–‰ì„ ì‹¬ì˜í•˜ê³  ì§‘í–‰í•œë‹¤. ìš´ì˜ìœ„ì›íšŒëŠ” ì—°ì´ˆì— ì—°ê°„ ì‚¬ì—…ê³„íšê³¼ ì¼ì •ì„ ì „ì²´ íšŒì›ë“¤ì—ê²Œ ê³µì§€í•œë‹¤.
2. ìš´ì˜ìœ„ì›íšŒëŠ” íšŒì¥, ìš´ì˜ìœ„ì›ì¥, ë“±ì‚°ëŒ€ì¥, ì¬ë¬´ìœ„ì›, ë° ê¸°íƒ€ ìš´ì˜ìœ„ì› 5ëª… ë‚´ì™¸ë¡œ êµ¬ì„±ëœë‹¤. ê°ì‚¬ 2ì¸ì€ ìš´ì˜ìœ„ì›íšŒì— ì°¸ì„í•  ê¶Œë¦¬ì™€ ì˜ë¬´ë¥¼ ì§€ë‹Œë‹¤. ìš´ì˜ìœ„ì›íšŒ êµ¬ì„±ì›ì€ ìˆ˜ì‹œë¡œ ì˜ê²¬ì„ ì¡°ìœ¨í•˜ë©°, ì—…ë¬´ë¶„ë‹´ì´ ì›í™œí•˜ê²Œ ë˜ë„ë¡ ë…¸ë ¥í•œë‹¤.

## ì œ 10ì¡° (ì„ ì¶œ ë° ì„ê¸°)
1. íšŒì¥, ê°ì‚¬ 2ì¸, ë° ìš´ì˜ìœ„ì›ì¥ì€ ëŒ€ì˜ì›íšŒì˜ì˜ ì„ ê±°ë¥¼ í†µí•´ ì„ ì¶œí•œë‹¤.
2. íšŒì¥ ë° ê°ì‚¬ 2ì¸ì˜ ì„ê¸°ëŠ” 2ë…„ì´ê³ , 1ë…„ ë‹¨ìœ„ë¡œ ì—°ì„í•  ìˆ˜ ìˆë‹¤. ìš´ì˜ìœ„ì›ì¥ì˜ ì„ê¸°ëŠ” 1ë…„ì´ê³ , 1ë…„ ë‹¨ìœ„ë¡œ ì—°ì„í•  ìˆ˜ ìˆë‹¤.
3. ë“±ì‚°ëŒ€ì¥ì€ ìš´ì˜ìœ„ì›íšŒì—ì„œ ìœ„ì´‰í•˜ê³  ëŒ€ì˜ì›íšŒì˜ì—ì„œ ì¸ì¤€í•˜ë©°, ì„ê¸°ëŠ” 2ë…„ì´ê³ , 1ë…„ ë‹¨ìœ„ë¡œ ì—°ì„í•  ìˆ˜ ìˆë‹¤.
4. ì¬ë¬´ìœ„ì›ê³¼ ê¸°íƒ€ ìš´ì˜ìœ„ì›ì€ íšŒì¥ê³¼ ìš´ì˜ìœ„ì›ì¥ì´ íšŒì›ì˜ ëŒ€í‘œì„±ì„ ê³ ë ¤í•˜ì—¬ í˜‘ì˜í•œ í›„ ìœ„ì´‰í•˜ë©°, ëŒ€ì˜ì›íšŒì˜ì—ì„œ ì¸ì¤€í•œë‹¤.

---

# ì œ 4ì¥. ëŒ€ì˜ì›íšŒì˜

## ì œ 11ì¡° (êµ¬ì„±ê³¼ ì„±ë¦½)
1. ëŒ€ì˜ì›íšŒì˜ëŠ” ë³¸íšŒì˜ ìµœê³  ì˜ê²° ê¸°êµ¬ì´ë©°, íšŒì¥, ê°ì‚¬, ë° ìš´ì˜ìœ„ì›ì¥ì„ ì„ ì¶œí•˜ê³ , ì¬ë¬´ìœ„ì›ê³¼ ê¸°íƒ€ ìš´ì˜ìœ„ì›ì˜ ì„ ì„ì„ ì¸ì¤€í•˜ë©°, ë³¸íšŒì˜ ì˜ˆì‚°ì§‘í–‰, ê²°ì‚°ë³´ê³ , ë° ì œë°˜ ì‚¬ì—…ì„ ì‹¬ì˜í•˜ê³  ì˜ê²°í•˜ë©°, í•„ìš”í•œ ê²½ìš° íšŒì¹™ì„ ê°œì •í•  ìˆ˜ ìˆë‹¤.
2. ëŒ€ì˜ì›ì€ íšŒì› ì¤‘ ìµœê·¼ 12ê°œì›”(ì „ë…„ë„ 11ì›”ë¶€í„° ë‹¹í•´ì—°ë„ 10ì›”ê¹Œì§€)ì˜ ì •ê¸°ì‚°í–‰ ì°¸ì—¬ìœ¨ì´ 40% (ë‹¹ì¼ ì •ê¸°ì‚°í–‰ì€ 1íšŒ, 1ë°•2ì¼ ì‚°í–‰ì€ 2íšŒ, í•´ì™¸ì‚°í–‰ì€ 3íšŒë¡œ ì‚°ìˆ í•˜ì—¬ ì´ 15íšŒ ì¤‘ 6íšŒ) ì´ìƒì¸ íšŒì›ìœ¼ë¡œ í•œë‹¤. íšŒì¥ì€ ë§¤í•´ 10ì›” ì •ê¸°ì‚°í–‰ ì§í›„ ì´ ê¸°ì¤€ì„ ì ìš©í•˜ì—¬ ê° íšŒì›ì˜ ëŒ€ì˜ì› ìê²©ì—¬ë¶€ë¥¼ êµ¬ë¶„í•˜ì—¬ ìƒˆë¡œìš´ ëŒ€ì˜ì›íšŒì˜ë¥¼ êµ¬ì„±í•˜ë©°, ê·¸ ì„ê¸°ëŠ” 1ë…„ì´ë‹¤.
3. ëŒ€ì˜ì›ì€ ëŒ€ì˜ì›íšŒì˜ì—ì„œ ë°œì–¸ê¶Œ, ë°œì˜ê¶Œ, ì˜ê²°ê¶Œ, ë° ì„ì› ì„ ê±°ê¶Œì„ ê°–ëŠ”ë‹¤.

## ì œ 12ì¡° (ì˜ê²°)
1. íšŒì¥ì€ ì—° 1íšŒ, 10ì›”ì— ëŒ€ì˜ì›íšŒì˜ ì •ê¸°ì´íšŒë¥¼ ì†Œì§‘í•˜ë©°, í•„ìš”í•œ ê²½ìš° ì„ì‹œì´íšŒë¥¼ ì†Œì§‘í•  ìˆ˜ ìˆë‹¤. ëŒ€ì˜ì› 5ì¸ ì´ìƒì˜ ë°œì˜ê°€ ìˆì„ ë•Œ íšŒì¥ì€ ì„ì‹œì´íšŒë¥¼ ì†Œì§‘í•˜ì—¬ì•¼ í•œë‹¤.
2. ì •ê¸°ì´íšŒ ë° ì„ì‹œì´íšŒëŠ” ìµœì†Œ 2ì£¼ ì „ì— ëŒ€ì˜ì› ì „ì›ì—ê²Œ ê³µì§€ë˜ì–´ì•¼ í•œë‹¤. ì´íšŒëŠ” ì˜¤í”„ë¼ì¸ ë˜ëŠ” ì˜¨ë¼ì¸ìœ¼ë¡œ ì§„í–‰ ê°€ëŠ¥í•˜ë‹¤.
3. íšŒì¹™ì˜ ê°œì •ì€ ëŒ€ì˜ì› ê³¼ë°˜ìˆ˜ ì´ìƒì˜ ì¶œì„ê³¼ ì¶œì„ëŒ€ì˜ì› 2/3ì´ìƒì˜ ì°¬ì„±ìœ¼ë¡œ í•˜ë©°, ê¸°íƒ€ ì œë°˜ ì‚¬í•­ì€ ê³¼ë°˜ìˆ˜ ì´ìƒì˜ ì¶œì„ê³¼ ì¶œì„ëŒ€ì˜ì› ê³¼ë°˜ìˆ˜ ì´ìƒì˜ ì°¬ì„±ìœ¼ë¡œ ì˜ê²°í•œë‹¤. ì˜ê²°ì •ì¡±ìˆ˜ê°€ ë¯¸ë‹¬ë˜ëŠ” ê²½ìš° ì†Œì§‘ëœ ì´íšŒì—ì„œëŠ” ì‹¬ì˜ë§Œ í•˜ê³ , ì˜ê²°ì€ SNS ë‹¨ì²´ëŒ€í™”ë°©ì„ í†µí•˜ì—¬ ì‹¤ì‹œí•œë‹¤.
4. íšŒì¥ì€ ëŒ€ì˜ì›íšŒì˜ ì´íšŒ ê²°ê³¼ë¥¼ ì „ì²´ íšŒì›ë“¤ì—ê²Œ ê³µì§€í•œë‹¤.

---

# ì œ 5ì¥. ì¬ì •

## ì œ 13ì¡° (ìˆ˜ì…)
1. íšŒë¹„ëŠ” ì—°íšŒë¹„ì™€ ì •ê¸°ì‚°í–‰ ì°¸ê°€ë¹„ë¡œ êµ¬ë¶„ëœë‹¤. ì •ê¸°ì‚°í–‰ ì°¸ê°€ë¹„ëŠ” ìˆ˜ìµì ë¶€ë‹´ì„ ì›ì¹™ìœ¼ë¡œ í•œë‹¤. í•´ì™¸ì‚°í–‰ ê²½ë¹„ëŠ” ë³„ë„ë¡œ ê´€ë¦¬í•˜ë©°, ì°¸ê°€ë¹„ëŠ” ìˆ˜ìµì ë¶€ë‹´ìœ¼ë¡œ í•œë‹¤.
2. ì‚°í–‰ ë¶ˆì°¸ ì‹œ ë‚©ë¶€ëœ ì •ê¸°ì‚°í–‰ ì°¸ê°€ë¹„ëŠ” ì‚°í–‰ 3ì¼ ì „ê¹Œì§€ ìš´ì˜ìœ„ì›ì¥ì—ê²Œ í†µì§€í•˜ëŠ” ê²½ìš°ì— í•œí•´ ë°˜ë‚©ëœë‹¤.
3. íšŒë¹„ëŠ” ë‹¹í•´ì—°ë„ì˜ ìš´ì˜ìœ„ì›íšŒê°€ ê²°ì •í•œë‹¤. ì „ë…„ë„ ê²°ì‚° í›„ ì‰ì—¬ê¸ˆ ë˜ëŠ” ë¶€ì¡±ê¸ˆì˜ ì •ë„ì— ë”°ë¼ ë‹¹í•´ì—°ë„ì˜ ì—°íšŒë¹„ ë° ì°¸ê°€ë¹„ë¥¼ ì¦ê°í•  ìˆ˜ ìˆë‹¤. íšŒì›ì€ 1ì›” ì •ê¸°ì‚°í–‰ ì´ì „ê¹Œì§€ ì—°íšŒë¹„ë¥¼ ë‚©ë¶€í•˜ì—¬ì•¼ í•œë‹¤.
4. ê·¸ ì™¸ì— íšŒì›ì˜ ìë°œì  ì°¬ì¡°ê¸ˆ/ê¸°ë¶€ê¸ˆì€ ê·¸ ëœ»ì— ë”°ë¼ ì í•©í•˜ê²Œ ì‚¬ìš©í•œë‹¤.

## ì œ 14ì¡° (ì§€ì¶œ)
1. ì§€ì¶œì€ ë³¸íšŒì˜ ëª©ì ì— ë¶€í•©ë˜ëŠ” ë²”ìœ„ ë‚´ì—ì„œ ì‚¬ìš©í•œë‹¤. ì—°íšŒë¹„ ìˆ˜ì…ì˜ ì¼ì • ë¶€ë¶„ì„ ì •ê¸°ì‚°í–‰ê³¼ í•´ì™¸ì‚°í–‰ì˜ ì§€ì›ì— ì‚¬ìš©í•œë‹¤.
2. ëª¨ë“  ì§€ì¶œ ìš©ë„ëŠ” ì‚¬ì „ì— ìš´ì˜ìœ„ì›íšŒì˜ ì‹¬ì˜ë¥¼ ê±°ì³ì•¼ í•˜ë©°, ì§€ì¶œ ë‚´ì—­ì„ ì¬ë¬´ìœ„ì›ì—ê²Œ ì œì¶œí•˜ì—¬ì•¼ í•œë‹¤.

## ì œ 15ì¡° (íšŒê³„ ë° ê²°ì‚°)
1. ë³¸íšŒì˜ ìˆ˜ì…ê³¼ ì§€ì¶œì€ ì¬ë¬´ìœ„ì› ëª…ì˜ì˜ ì‹œì¤‘ì€í–‰ ëª¨ì„í†µì¥ìœ¼ë¡œ ê´€ë¦¬í•˜ë©°, ìš´ì˜ìœ„ì› ì „ì›ì„ ëª¨ì„ë©¤ë²„ë¡œ ë“±ë¡í•œë‹¤.
2. ì¬ë¬´ìœ„ì›ì€ ê° ì‚°í–‰ ë° ì—¬íƒ€í–‰ì‚¬ ì´í›„ íšŒì›ë“¤ì—ê²Œ SNSë¥¼ í†µí•´ ìˆ˜ì…ê³¼ ì§€ì¶œ ë‚´ì—­ì„ ë³´ê³ í•œë‹¤.
3. ì¬ë¬´ìœ„ì›ì€ íšŒê³„ì—°ë„ ê²°ì‚°ì„ ë‹¹í•´ 12ì›” ì •ê¸°ì‚°í–‰ ì§í›„ ìš´ì˜ìœ„ì›íšŒì— ë³´ê³ í•˜ê³ , ê°ì‚¬ëŠ” íšŒê³„ê°ì‚¬ë¥¼ ì‹¤ì‹œí•œë‹¤. ìš´ì˜ìœ„ì›íšŒëŠ” íšŒê³„ì—°ë„ ê²°ì‚° ë° ê°ì‚¬ ê²°ê³¼ë¥¼ 12ì›” 24ì¼ê¹Œì§€ ì „ì²´ íšŒì›ë“¤ì—ê²Œ SNSë¥¼ í†µí•´ ë³´ê³ í•œë‹¤.
4. ë³¸íšŒì˜ íšŒê³„ì—°ë„ëŠ” ë§¤ë…„ 1ì›” 1ì¼ë¶€í„° 12ì›” 31ì¼ê¹Œì§€ë¡œ í•œë‹¤.

---

# ì œ 6ì¥. ê¸°íƒ€

## ì œ 16ì¡° (SNS ë‹¨ì²´ëŒ€í™”ë°©)
íšŒì› ê°„ì˜ ì¹œëª©ê³¼ í˜‘ë ¥ì„ ë„ëª¨í•  ëª©ì ìœ¼ë¡œ íšŒì› ëŒ€ìƒì˜ SNS ë‹¨ì²´ëŒ€í™”ë°©ì„, ëŒ€ì˜ì› ê°„ì˜ ì›í™œí•œ ì˜ê²¬êµí™˜ì„ ìœ„í•˜ì—¬ ëŒ€ì˜ì›íšŒì˜ì˜ SNS ë‹¨ì²´ëŒ€í™”ë°©ì„ ê°ê° ìš´ì˜í•œë‹¤. ë‹¨ì²´ëŒ€í™”ë°©ì˜ êµ¬ì„±ì›ì€ ì„¸ì¹™ì— ì •í•œ ê°€ì´ë“œë¼ì¸ì„ ì² ì €íˆ ì¤€ìˆ˜í•˜ì—¬ì•¼ í•œë‹¤.

## ì œ 17ì¡° (ë¹„íšŒì›ì˜ ì‚°í–‰ì°¸ê°€)
íšŒì› ê°€ì¡±ì„ í¬í•¨í•œ ë¹„íšŒì›ì€ íšŒì›ì˜ ì´ˆì²­ì— ì˜í•´ ì •ê¸°ì‚°í–‰ì— ì—° 2íšŒì— í•œì •í•˜ì—¬ ì°¸ê°€ê°€ í—ˆìš©ë˜ë©°, í•´ë‹¹ ì‚°í–‰ ì°¸ê°€ë¹„ë¥¼ ë‚©ë¶€í•˜ì—¬ì•¼ í•œë‹¤.

## ì œ 18ì¡° (ìˆ˜ìµì˜ ë¶„ë°°)
ë³¸íšŒì˜ ì‰ì—¬ê¸ˆì€ íšŒì›ì— ë¶„ë°°í•˜ì§€ ì•„ë‹ˆí•œë‹¤. ë³¸íšŒë¥¼ í•´ì‚°í•˜ëŠ” ê²½ìš° ì‰ì—¬ê¸ˆì€ ëŒ€ì˜ì›íšŒì˜ì—ì„œ ê²°ì •í•˜ëŠ” ê³µìµë‹¨ì²´ì— ê¸°ë¶€í•œë‹¤.

---

# ë¶€ì¹™

## ì œ 19ì¡° (íšŒì¹™ ì¤€ìš©)
ë³¸ íšŒì¹™ì— ê·œì •ë˜ì§€ ì•Šì€ ì‚¬í•­ì€ ë‚´ê·œ ë° ì¼ë°˜ê´€ë¡€ì— ë”°ë¥´ë©°, ë‚´ê·œëŠ” ìš´ì˜ìœ„ì›íšŒì˜ ì˜ê²°ë¡œ ì •í•œë‹¤.

## ì œ 20ì¡° (ì‹œí–‰ì¼)
ë³¸ íšŒì¹™ì€ ëŒ€ì˜ì›íšŒì˜ì—ì„œ í†µê³¼í•œ ë‚ (2025ë…„ 10ì›” 30ì¼)ë¶€í„° ì‹œí–‰í•œë‹¤.

---

# ë‹¨ì²´ëŒ€í™”ë°© ê°€ì´ë“œë¼ì¸

1. ë‹¨ì²´ëŒ€í™”ë°©ì—ëŠ” íšŒì› ëª¨ë‘ì—ê²Œ ìœ ìµí•˜ê³  ê´€ì‹¬ ìˆì„ ë‚´ìš©ë§Œì„ ê²Œì¬í•œë‹¤.
2. ì •ì¹˜ì  ë˜ëŠ” ì¢…êµì  ì„±í–¥ì´ ë“œëŸ¬ë‚˜ëŠ” ê¸€ì„ ì˜¬ë¦¬ì§€ ì•ŠëŠ”ë‹¤.
3. ì•„ì¹¨ 6ì‹œ ì´ì „, ë°¤ 11ì‹œ ì´í›„ì—ëŠ” ê¸€ì„ ì˜¬ë¦¬ì§€ ì•ŠëŠ”ë‹¤.
4. íšŒì›ë™í–¥ ë° ê²½ì¡°ì‚¬ ì†Œì‹ì€ ìš´ì˜ìœ„ì›ì¥ì—ê²Œ ì „ë‹¬í•˜ë©°, ìš´ì˜ìœ„ì›ì¥ì€ ê·¸ ì í•©ì„± ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ì—¬ ê²Œì¬í•œë‹¤. ê²½ì¡°ì‚¬ì— ëŒ€í•œ ë‹µê¸€ì€ í•´ë‹¹ íšŒì›ì—ê²Œ ê°œë³„ë¡œ ì „ë‹¬í•œë‹¤.
5. ì¼ë¶€ íšŒì›ë“¤ì—ê²Œ êµ­í•œë˜ëŠ” ë‚´ìš©ì€ ë³„ë„ì˜ ëŒ€í™”ë°©ì—ì„œ ì†Œí†µí•œë‹¤.
6. ìš´ì˜ìœ„ì›ì¥ì€ ë‹¨ì²´ëŒ€í™”ë°©ì˜ ë©¤ë²„ ê´€ë¦¬ ë° ë©”ì‹œì§€ ê´€ë¦¬ ê¶Œí•œì„ ê°–ëŠ”ë‹¤.
7. ë³¸ ê°€ì´ë“œë¼ì¸ì„ í˜„ì €íˆ ë˜ëŠ” ë°˜ë³µí•˜ì—¬ ì–´ê¸°ëŠ” ê²½ìš°ì—ëŠ” ìš´ì˜ìœ„ì›íšŒì˜ ì˜ê²°ì„ ê±°ì³ ì œì¬í•œë‹¤.`;

const RULES_DOC_ID = 'current_rules';

const initialRulesData: RulesData = {
  id: RULES_DOC_ID,
  content: initialRulesContent,
  version: '2025.10.30',
  effectiveDate: '2025ë…„ 10ì›” 30ì¼',
  amendments: [
    {
      version: '2025.10.30',
      date: '2025ë…„ 10ì›” 30ì¼',
      description: 'íšŒì¹™ ì œì • (ëŒ€ì˜ì›íšŒì˜ í†µê³¼)'
    }
  ],
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
};

export const RulesProvider = ({ children }: { children: ReactNode }) => {
  const [rulesData, setRulesData] = useState<RulesData>(initialRulesData);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [hasLoadedOnce, setHasLoadedOnce] = useState(false);
  
  // ğŸ”¥ AuthContext ì‚¬ìš©
  const auth = useAuth();

  const loadRules = useCallback(async () => {
    try {
      setIsLoading(true);
      setError(null);

      console.log('ğŸ”„ [RulesContext] rules ë°ì´í„° ë¡œë“œ ì‹œì‘');

      const result = await getDocuments<RulesData>('rules');
      if (result.success && result.data && result.data.length > 0) {
        // ì²« ë²ˆì§¸ ë¬¸ì„œë¥¼ í˜„ì¬ íšŒì¹™ìœ¼ë¡œ ì‚¬ìš©
        setRulesData(result.data[0]);
        console.log('âœ… Firebaseì—ì„œ íšŒì¹™ ë°ì´í„° ë¡œë“œ:', result.data[0].version);
      } else {
        console.log('â„¹ï¸ Firebaseì— íšŒì¹™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
        // ì´ˆê¸° ë°ì´í„°ë¥¼ Firebaseì— ì €ì¥
        await setDocument('rules', RULES_DOC_ID, initialRulesData);
        console.log('âœ… ì´ˆê¸° íšŒì¹™ ë°ì´í„° ì €ì¥ ì™„ë£Œ');
      }
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : 'Unknown error';
      console.error('âŒ Firebase íšŒì¹™ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', message);
      setError(message);
      logError(error, ErrorLevel.ERROR, ErrorCategory.DATABASE, {
        context: 'RulesContext.loadRules',
      });
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Firebaseì—ì„œ íšŒì¹™ ë°ì´í„° ë¡œë“œ - ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ ì¬ë¡œë“œ
  useEffect(() => {
    const initializeData = async () => {
      console.log('ğŸ”„ [RulesContext] ë°ì´í„° ë¡œë“œ ì‹œì‘, ì¸ì¦ ìƒíƒœ:', {
        isAuthenticated: !!auth.firebaseUser,
        email: auth.firebaseUser?.email,
        hasLoadedOnce
      });
      
      // ë¡œê·¸ì¸ ìƒíƒœì´ê±°ë‚˜ ì•„ì§ í•œ ë²ˆë„ ë¡œë“œí•˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ë¡œë“œ
      if (auth.firebaseUser || !hasLoadedOnce) {
        await loadRules();
        setHasLoadedOnce(true);
      }
    };
    
    // Auth ë¡œë”©ì´ ì™„ë£Œëœ í›„ì—ë§Œ ì‹¤í–‰
    if (!auth.isLoading) {
      initializeData();
    }
  }, [auth.firebaseUser, auth.isLoading, loadRules]);

  const updateRules = useCallback(async (content: string, version: string, effectiveDate: string) => {
    try {
      const updatedData = {
        ...rulesData,
        content,
        version,
        effectiveDate,
        updatedAt: new Date().toISOString(),
      };

      const result = await updateDocument('rules', RULES_DOC_ID, updatedData);
      
      if (result.success) {
        setRulesData(updatedData);
        console.log('âœ… íšŒì¹™ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', version);
      } else {
        throw new Error(result.error || 'íšŒì¹™ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
      }
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : 'Unknown error';
      console.error('âŒ íšŒì¹™ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', message);
      logError(error, ErrorLevel.ERROR, ErrorCategory.DATABASE, {
        context: 'RulesContext.updateRules',
        version,
      });
      throw error;
    }
  }, [rulesData]);

  const addAmendment = useCallback(async (amendment: RulesAmendment) => {
    try {
      const updatedData = {
        ...rulesData,
        amendments: [...rulesData.amendments, amendment],
        updatedAt: new Date().toISOString(),
      };

      const result = await updateDocument('rules', RULES_DOC_ID, updatedData);
      
      if (result.success) {
        setRulesData(updatedData);
        console.log('âœ… ê°œì • ì´ë ¥ ì¶”ê°€ ì™„ë£Œ:', amendment.version);
      } else {
        throw new Error(result.error || 'ê°œì • ì´ë ¥ ì¶”ê°€ ì‹¤íŒ¨');
      }
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : 'Unknown error';
      console.error('âŒ ê°œì • ì´ë ¥ ì¶”ê°€ ì‹¤íŒ¨:', message);
      logError(error, ErrorLevel.ERROR, ErrorCategory.DATABASE, {
        context: 'RulesContext.addAmendment',
        version: amendment.version,
      });
      throw error;
    }
  }, [rulesData]);

  const refreshRules = useCallback(async () => {
    await loadRules();
  }, [loadRules]);

  const value = useMemo(
    () => ({
      rulesData,
      isLoading,
      error,
      updateRules,
      addAmendment,
      refreshRules,
    }),
    [rulesData, isLoading, error, updateRules, addAmendment, refreshRules]
  );

  return (
    <RulesContext.Provider value={value}>
      {children}
    </RulesContext.Provider>
  );
};

export const useRules = () => {
  const context = useContext(RulesContext);
  if (context === undefined) {
    throw new Error('useRules must be used within a RulesProvider');
  }
  return context;
};
